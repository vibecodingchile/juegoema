<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mundo Virtual de Eva</title>
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; background:#0f1220; color:#e9ecff; display:grid; place-items:center; min-height:100vh; }
    .wrap { width:min(900px, 96vw); display:grid; gap:12px; }
    .top { display:flex; gap:12px; align-items:stretch; flex-wrap:wrap; }
    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:10px 0;">
  <button class="btn" id="up">â¬†ï¸</button>
  <button class="btn" id="left">â¬…ï¸</button>
  <button class="btn" id="down">â¬‡ï¸</button>
  <button class="btn" id="right">â¡ï¸</button>
  <button class="btn" id="act">E</button>
</div>
 canvas { background:#141a33; border:1px solid #2a3160; border-radius:14px; width:100%; height:auto; }
    .panel {
      flex: 1 1 280px;
      background:#141a33;
      border:1px solid #2a3160;
      border-radius:14px;
      padding:12px;
      min-height: 160px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { padding:4px 10px; border-radius:999px; background:#1e2550; border:1px solid #2a3160; font-size:12px; }
    .btn {
      cursor:pointer; border:1px solid #2a3160; background:#1e2550; color:#e9ecff;
      padding:8px 10px; border-radius:10px; font-weight:600;
    }
    .btn:active { transform: translateY(1px); }
    .log { margin-top:10px; font-size:14px; line-height:1.25; max-height:220px; overflow:auto; }
    .hint { opacity:.85; font-size:13px; margin-top:8px; }
    .inv { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { font-size:12px; padding:4px 8px; border-radius:999px; background:#10163a; border:1px solid #2a3160; }
    .title { font-size:18px; font-weight:800; margin:0 0 6px 0; }
    .muted { opacity:.8; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0d1030; border:1px solid #2a3160; padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="panel">
        <p class="title">ğŸŒ Mundo Virtual de Eva</p>
        <div class="row">
          <span class="badge">Mover: <span class="kbd">W A S D</span> / flechas</span>
          <span class="badge">Interactuar: <span class="kbd">E</span></span>
          <span class="badge">Objetivo: conseguir el ğŸ† tesoro</span>
        </div>
        <div class="hint muted">
          Tip: necesitas la ğŸ”¦ linterna antes de entrar a la cueva.
        </div>

        <div class="inv" id="inv"></div>
        <div class="log" id="log"></div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="reset">Reiniciar</button>
          <button class="btn" id="nameBtn">Cambiar nombre</button>
        </div>
      </div>
    </div>

    <canvas id="game" width="900" height="520"></canvas>
  </div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const logEl = document.getElementById("log");
  const invEl = document.getElementById("inv");
  const resetBtn = document.getElementById("reset");
  const nameBtn = document.getElementById("nameBtn");

  let playerName = "Eva";
  let inventory = new Set();
  let won = false;

  const TILE = 40;
  const mapW = 22; // 22*40=880 (dejamos margen)
  const mapH = 12; // 12*40=480

  // 0 = suelo, 1 = pared/Ã¡rbol, 2 = agua, 3 = puerta/casa, 4 = entrada cueva (bloqueada sin linterna), 5 = suelo especial lago
  const world = [
    // 22 columnas x 12 filas
    "1111111111111111111111",
    "1...........111........1",
    "1..333......1.1....222.1",
    "1..3.3......1.1....2.2.1",
    "1..333.......... ..222..1".replace(/ /g,""),
    "1..............111......1",
    "1....11111...........1111",
    "1....1...1.....444...1..1",
    "1....1...1.....4.4...1..1",
    "1....11111.....444...1..1",
    "1..................... ..1".replace(/ /g,""),
    "1111111111111111111111",
  ].map(row => row.split("").map(ch => {
    if (ch === "1") return 1;
    if (ch === "2") return 2;
    if (ch === "3") return 3;
    if (ch === "4") return 4;
    if (ch === ".") return 0;
    return 0;
  }));

  // Entidades: objetos y npc con posiciÃ³n en tiles
  const entitiesStart = () => ([
    { type:"item", id:"linterna", icon:"ğŸ”¦", x:4, y:3, msg:"Has conseguido una linterna. Â¡Ahora podrÃ¡s entrar a la cueva!" },
    { type:"npc",  id:"duende",  icon:"ğŸ§", x:7, y:6, msg:"Hola " + playerName + "! Si quieres ir a la cueva, necesitas una linterna ğŸ”¦." },
    { type:"item", id:"piedra",  icon:"ğŸª¨", x:18, y:3, msg:"Encontraste una piedra mÃ¡gica. Brilla un poquito âœ¨." },
    { type:"item", id:"tesoro",  icon:"ğŸ†", x:12, y:8, msg:"Â¡TESORO! ğŸ‰ Ganaste. Â¡Eres genial, " + playerName + "!" },
  ]);

  let entities = entitiesStart();

  const player = {
    x: 5, y: 5, // en tiles
    px: 0, py: 0,
    speed: 6,
  };

  function tileAt(tx, ty) {
    if (tx < 0 || ty < 0 || tx >= mapW || ty >= mapH) return 1;
    return world[ty][tx] ?? 1;
  }

  function isSolid(tile) {
    return tile === 1 || tile === 2 || tile === 3 || tile === 4; // casa/agua/entrada cueva bloquean
  }

  function canEnterCave(tile) {
    // tile 4 = entrada de cueva: solo si hay linterna
    return tile !== 4 || inventory.has("linterna");
  }

  function log(msg) {
    const p = document.createElement("div");
    p.textContent = msg;
    logEl.prepend(p);
  }

  function renderInventory() {
    invEl.innerHTML = "";
    const label = document.createElement("span");
    label.className = "badge";
    label.textContent = "ğŸ’ Inventario:";
    invEl.appendChild(label);

    if (inventory.size === 0) {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = "(vacÃ­o)";
      invEl.appendChild(chip);
      return;
    }
    for (const it of inventory) {
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = it === "linterna" ? "ğŸ”¦ linterna" : it ===
